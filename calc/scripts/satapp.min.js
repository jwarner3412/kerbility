var dataList=[],antList,$form={container:document.getElementsByClassName("calcWrap"),instructionButton:document.getElementById("instructionButton"),doMaths:document.getElementById("doMaths"),solSelect:document.getElementById("solSelect"),bodySelect:document.getElementById("bodySelect"),precInput:document.getElementById("precInput"),satCount:document.getElementById("satCount"),targBySelect:document.getElementById("targBySelect"),targAltInput:document.getElementById("targAltInput"),perDayInput:document.getElementById("perDayInput"),perHourInput:document.getElementById("perHourInput"),perMinInput:document.getElementById("perMinInput"),perSecInput:document.getElementById("perSecInput"),perInput:document.getElementsByClassName("perInputs"),depPe:document.getElementById("depPe"),depAp:document.getElementById("depAp"),results:document.getElementById("results"),help:document.getElementById("helpWrap"),helpClose:document.getElementById("helpClose"),optList:[],snapOpt:[0,0,0,0,0]};$form.importData=function(t,e){var n=new XMLHttpRequest;n.onreadystatechange=function(){if(n.readyState===XMLHttpRequest.DONE){var a=JSON.parse(n.responseText);if(console.log(t+" JSON data parsed."),"function"!=typeof e)return a;e(a)}else console.log(t+" Elevator music...")},n.open("GET",t,!0),n.send()},$form.selectBuild=function(t,e){function n(t,e,n){var a=document.createElement("option");a.value=t,a.text=e,"function"==typeof n.add?n.add(a):"function"==typeof n.push?n.push(a):console.log("fail")}return dataList=t,dataList.forEach(function(t,e){n(e,t.name,this.solSelect);var a=[];dataList[e].bodys.forEach(function(t,e){"Sun"===t.orbits?n(e,t.bodyName,a):0===t.orbits?n(e,"* "+t.bodyName+" *",a):n(e," -"+t.bodyName,a)}),$form.optList.push(a)}),console.log("Building select options from JSON data."),"function"!=typeof e?this:void e()};var SnapInput=function(t){this.math={},this.math.calcSMA=function(t,e){var n=(2*t+2*e)/2;return n},this.math.calcPER=function(t,e){var n=2*Math.PI*Math.sqrt(Math.pow(t,3)/e);return n},this.math.calcRa=function(t,e,n,a){var r=2*n,o=Math.pow(r,1/3),s=Math.pow(t,2/3),i=Math.pow(Math.PI,2/3);a&&(i*=a);var l=s*o/i-e;return l},this.math.parseSec=function(t,e){var n=Math.floor(t%60*1e3)/1e3,a=Math.floor(t%3600/60),r=Math.floor(t%e/3600),o=Math.floor(t/e),s=[o,r,a,n];return s},this.body={},this.body=t[0];var e=(parseFloat(t[1]),parseInt(t[2],10)),n=parseFloat(t[3]),a=t[4],r=this.body.radiusM,o=this.body.MUms3,s=this.body.siderealDayS;"alt"!==a&&(n=this.math.calcRa(n,r,o,2)),this.target={},this.target.altM=n,this.target.semiMajAxis=this.math.calcSMA(n,r),this.target.per=this.math.calcPER(this.target.semiMajAxis,o),this.target.time=this.math.parseSec(this.target.per,s),this.target.orbSpeed=Math.sqrt(o*(1/this.target.semiMajAxis)),this.deploy={},this.deploy.ratio=1+1/e,this.deploy.per=this.target.per*this.deploy.ratio,this.deploy.time=this.math.parseSec(this.deploy.per,s),this.deploy.Rp=this.target.semiMajAxis,this.deploy.Ra=this.math.calcRa(this.deploy.per,this.deploy.Rp,o),this.deploy.semiMajAxis=(this.deploy.Rp+this.deploy.Ra)/2,this.deploy.Pe=this.target.altM,this.deploy.Ap=this.deploy.Ra-r;var i=2/this.deploy.Rp-1/this.deploy.semiMajAxis;this.deploy.obtSpdPE=Math.sqrt(o*i),this.deploy.circDVreq=this.target.orbSpeed-this.deploy.obtSpdPE,this.satInfo={}};Math.radians=function(t){return t*Math.PI/180},$form.setDec=function(t){return Math.floor(1e3*t)/1e3},$form.minMath=function(){var t=this.snapOpt[0],e=t.radiusM,n=t.soiRadM,a=t.minPE,r=parseFloat(this.snapOpt[1]),o=parseInt(this.snapOpt[2],10),s=Math.radians(180/o+r),i=Math.max(Math.ceil(e/Math.cos(s)-e),a),l=[t,r,o,i,"alt"];this.minOrbit=new SnapInput(l),console.log("minOrbit calculated: "+$form.minOrbit.target.altM);var p=1+1/o,u=function(t,e){var n=Math.pow((2*t+2*e.radiusM)/2,3),a=2*Math.PI*Math.sqrt(n/e.MUms3);return a}(n,t),d=u/p/p,c=[t,r,o,d,"per"];return this.maxOrbit=new SnapInput(c),console.log("maxOrbit calculated: "+$form.maxOrbit.target.altM),this},$form.selectHandler=function(t){return console.log("Adding options to the body select."),this.bodySelect.options.length>0&&(this.bodySelect.options.length=0),$form.optList[this.solSelect.value].forEach(function(t){this.bodySelect.add(t),"Kerbin"!==t.text&&"Earth"!==t.text||(this.bodySelect.value=t.value)}),"function"==typeof t&&t(),this},$form.targHandler=function(t){var e;"alt"===this.targBySelect.value?(this.snapOpt[4]="alt",e=!1):(this.snapOpt[4]="per",e=!0),console.log("Set to: "+$form.snapOpt[4]),this.targAltInput.disabled=e;for(var n=0;n<$form.perInput.length;n++)$form.perInput[n].disabled=!e;return"function"==typeof t&&t(),this},$form.recordBody=function(t){return this.snapOpt[0]=dataList[this.solSelect.value].bodys[this.bodySelect.value],console.dir("Caching body: "+this.snapOpt[0]),"function"==typeof t&&t(),this},$form.zeroInputs=function(){if("alt"===this.targBySelect.value)this.targAltInput.value=0;else for(var t=0;t<$form.perInput.length;t++)$form.perInput[t].value=0;return this.satCount.value<2&&(this.satCount.value=2),this.snapOpt[1]=this.precInput.value,this.snapOpt[2]=this.satCount.value,console.log("Inputs set to 0. snapOpt's set: "+$form.snapOpt[1]+" "+$form.snapOpt[2]),this},$form.targValHandler=function(t){var e=function(t){for(var e=0;e<$form.perInput.length;e++)$form.perInput[e].value||($form.perInput[e].value=0);var n=parseFloat($form.perSecInput.value),a=60*parseInt($form.perMinInput.value,10),r=3600*parseInt($form.perHourInput.value,10),o=parseInt($form.perDayInput.value,10)*t;return n+=a+r+o,console.log("Time parsed from seconds."),n},n=function(t){var e=t.target.time;$form.perSecInput.value=e[3],$form.perMinInput.value=e[2],$form.perHourInput.value=e[1],$form.perDayInput.value=e[0]},a=function(t){return this.snapOpt[0]&&this.snapOpt[1]&&this.snapOpt[2]&&this.snapOpt[4]?(this.snapOpt[3]=t,this.input=new SnapInput(this.snapOpt),console.log("snapShot "+$form.snapOpt[3])):console.log("options not yet initialized"),this};if("alt"===this.snapOpt[4])(this.targAltInput.value<this.minOrbit.target.altM||!this.targAltInput.value)&&(console.log("Too low, setting minAlt."),this.targAltInput.value=this.setDec(this.minOrbit.target.altM)),a.call($form,$form.targAltInput.value),this.input.deploy.Ap>this.maxOrbit.deploy.Ap&&this.snapOpt[0].soiRadM&&(console.log("Too high, setting maxAlt."),this.targAltInput.value=this.setDec(this.maxOrbit.target.altM),a.call($form,$form.targAltInput.value)),n(this.input),console.log("Acceptable altitude. Time set.");else{var r=this.snapOpt[0].siderealDayS,o=e(r);o<this.minOrbit.target.per&&(console.log("Too low, setting minimum period."),o=this.minOrbit.target.per),a.call($form,o),o>this.maxOrbit.deploy.per&&this.snapOpt[0].soiRadM&&(console.log("Too high, setting max period."),o=this.maxOrbit.deploy.per,a.call($form,o)),console.log("Acceptable period. Alt updated."),n(this.input),this.targAltInput.value=this.setDec(this.input.target.altM)}return this.resultClear(),"function"==typeof t&&t(),this},$form.prevDefault=function(t){return t.preventDefault(),this},$form.eventTriggers=function(){$form.recordBody().zeroInputs().minMath().targValHandler(),$form.solSelect.addEventListener("change",function(){$form.selectHandler()}),$form.bodySelect.addEventListener("change",function(){$form.recordBody().zeroInputs().minMath().targValHandler()}),$form.satCount.addEventListener("change",function(){$form.zeroInputs().minMath().targValHandler()}),$form.precInput.addEventListener("change",function(){$form.zeroInputs().minMath().targValHandler()}),$form.targBySelect.addEventListener("change",function(){$form.targHandler()}),$form.targAltInput.addEventListener("change",function(){$form.targValHandler()}),$form.perSecInput.addEventListener("change",function(){$form.targValHandler()}),$form.perMinInput.addEventListener("change",function(){$form.targValHandler()}),$form.perHourInput.addEventListener("change",function(){$form.targValHandler()}),$form.perDayInput.addEventListener("change",function(){$form.targValHandler()}),$form.doMaths.addEventListener("click",function(t){t.preventDefault(),$form.resultHandler($form.input)}),$form.instructionButton.addEventListener("click",function(t){t.preventDefault(),$form.help.style.display="block"}),$form.helpClose.addEventListener("click",function(t){t.preventDefault(),$form.help.style.display="none"}),console.log("Event listeners set.")},$form.resultHandler=function(t){var e=function(t){var e=["d","h","m","s"],n=" ",a="";return t.forEach(function(t,r,o){t&&(a+=t+e[r]+n)}),a},n=function(t){var n=[" s"," m"," m/s"],a=Math.round(t.deploy.Ap).toLocaleString()+n[1],r=Math.round(t.deploy.Pe).toLocaleString()+n[1],o=$form.setDec(t.deploy.per).toLocaleString()+n[0],s=e(t.deploy.time),i=Math.round(t.deploy.semiMajAxis).toLocaleString()+n[1],l=$form.setDec(t.deploy.obtSpdPE).toLocaleString()+n[2],p=$form.setDec(t.deploy.circDVreq).toLocaleString()+n[2],u=Math.round(t.target.altM).toLocaleString()+n[1],d=$form.setDec(t.target.per).toLocaleString()+n[0],c=e(t.target.time),h=Math.round(t.target.semiMajAxis).toLocaleString()+n[1],m=$form.setDec(t.target.orbSpeed).toLocaleString()+n[2],f="<table><tbody>",g="<tr><td>",y="</td><td>",v="</td></tr>",I="</tbody></table>",$='<thead><th colspan="2">',M="Deployment Orbit Data",S="Final Target Orbit Data",b="</th></thead>",E=g+"Period",O=E;E+="(seconds): ",O+="(d:h:m:s): ";var A=g+y+v,L=f;L+=$+M+b,L+=g+"Apoapsis: "+y+a+v,L+=g+"Periapsis: "+y+r+v,L+=g+"Semi-Major-Axis: "+y+i+v,L+=A,L+=E+y+o+v,L+=O+y+s+v,L+=A,L+=g+"Speed@Periapsis: "+y+l+v,L+=A,L+=g+"Required Circ dV: "+y+p+v,L+=I,this.dString=L;var B=f;B+=$+S+b,B+=g+"Circular Alt: "+y+u+v,B+=g+"Semi-Major-Axis: "+y+h+v,B+=A,B+=E+y+d+v,B+=O+y+c+v,B+=A,B+=g+"Orbital Speed: "+y+m+v,B+=I,this.tString=B};this.snapRes=new n(t);var a=this.snapRes.dString+this.snapRes.tString;a+='<div class="buttWrap">',a+='<a href="http://paypal.me/jwarner3412/1.99">',a+="If you like the app, please donate</a> </div>",a+='<script type="text/javascript" src="//clksite.c',a+='om/adServe/banners?tid=113089_210277_2"></script>',document.getElementById("results").innerHTML=a},$form.resultClear=function(){console.log("Clearing Results"),this.results.innerHTML=""},function(){$form.importData("./data.json",function(t){$form.selectBuild(t).selectHandler().targHandler().eventTriggers()})}(),function(){antList=$form.importData("./ant.json")}();
